<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Queue Control</title>
    <style>
      :root {
          --bg: #1a1a1a;
          --panel: #2a2a2a;
          --accent: #d16ce6;
          --accent-hover: #ff66cc;
          --danger: #ff4b4b;
          --text: #e1e1e1;
          --muted: #aaa;
      }

      * { box-sizing: border-box; }

      body {
          margin: 0;
          font-family: "Roboto", system-ui, sans-serif;
          background: var(--bg);
          color: var(--text);
          display: flex;
          flex-direction: column;
          align-items: center;
      }

      h1 {
          margin: 12px 0;
          color: var(--accent);
          font-size: 1.6rem;
      }

      .controls {
          display: flex;
          gap: 10px;
          margin-bottom: 10px;
      }

      button {
          padding: 10px 14px;
          border-radius: 6px;
          border: none;
          background: var(--accent);
          color: white;
          font-weight: bold;
          cursor: pointer;
          transition: 0.2s;
      }

      button:hover { background: var(--accent-hover); }

      #queueToggle.closed {
          background: var(--danger);
      }

      table {
          width: 95%;
          max-width: 900px;
          border-collapse: collapse;
          background: var(--panel);
          border-radius: 8px;
          overflow: hidden;
      }

      thead {
          position: sticky;
          top: 0;
          z-index: 10;
      }

      th {
          background: var(--accent);
          color: white;
          padding: 12px;
          font-size: 1rem;
      }

      td {
          padding: 10px;
          border-bottom: 1px solid #333;
          text-align: center;
      }

      tbody tr:hover td {
          background: rgba(255,102,204,0.15);
      }

      td:first-child {
          width: 50px;
          font-weight: bold;
      }

      tr.draggable {
          cursor: grab;
      }

      tr.dragging {
          opacity: 0.4;
      }

      /* Bungie copy */
      .copyable {
          cursor: pointer;
          position: relative;
          color: #ffd1f2;
          font-weight: 500;
      }

      .copyable:hover {
          background: rgba(255,102,204,0.25);
      }

      .copyable::after {
          content: "Click to copy";
          position: absolute;
          bottom: -18px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 0.65rem;
          color: var(--muted);
          opacity: 0;
          transition: 0.2s;
      }

      .copyable:hover::after {
          opacity: 1;
      }

      .copied {
          background: var(--accent) !important;
          color: white !important;
      }

      /* Remove */
      .remove-button {
          background: var(--danger);
          padding: 6px 8px;
          border-radius: 4px;
          font-size: 0.8rem;
      }

      .remove-button:hover {
          background: #cc3a3a;
      }

      .group-separator td {
          background: #1f1f1f;
          color: #ff66cc;
          font-weight: bold;
          text-align: left;
          padding: 10px;
          font-size: 0.9rem;
          border-bottom: 2px solid #333;
      }

      #toast {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: #2a2a2a;
          color: white;
          padding: 10px 14px;
          border-radius: 6px;
          opacity: 0;
          transform: translateY(10px);
          transition: 0.3s ease;
          pointer-events: none;
          font-size: 0.9rem;
      }
      #toast.show {
          opacity: 1;
          transform: translateY(0);
      }
    </style>
</head>
<body>

<h1>OBS Queue Control</h1>

<div class="controls">
  <button onclick="nextQueue()">NEXT</button>
  <button id="queueToggle" onclick="toggleQueue()">Close Queue</button>
</div>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Name</th>
      <th>Bungie</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="queueBody"></tbody>
</table>

<script>
let queueOpen = true;
let draggedRow = null;

/* =======================
   COPY HANDLER
======================= */
function enableCopyHandlers() {
    document.querySelectorAll(".copyable").forEach(el => {
        el.onclick = async () => {
            const value = el.dataset.bungie;
            if (!value) return;

            try {
                await navigator.clipboard.writeText(value);

                el.classList.add("copied");
                const original = el.textContent;
                el.textContent = "Copied ✔";

                setTimeout(() => {
                    el.textContent = original;
                    el.classList.remove("copied");
                }, 800);
            } catch (e) {
                console.error("Clipboard error", e);
            }
        };
    });
}

/* =======================
   LOAD QUEUE
======================= */
async function loadQueue() {
    const res = await fetch("/api/obs/queue");
    if (!res.ok) return;

    const data = await res.json();
    queueOpen = data.open;
    updateToggle();
    let currentGroup = null;

    function groupName(pos, teamsize) {
        if (pos <= teamsize) return "LIVE";
        if (pos <= teamsize * 2) return "NEXT";
        return "QUEUE";
    }
    const tbody = document.getElementById("queueBody");
    tbody.innerHTML = "";

    data.queue.forEach(entry => {
        const group = groupName(entry.position, data.teamsize);

        if (group !== currentGroup) {
            currentGroup = group;

            const sep = document.createElement("tr");
            sep.className = "group-separator";
            sep.innerHTML = `<td colspan="4">${group}</td>`;
            tbody.appendChild(sep);
        }

        const tr = document.createElement("tr");
        tr.className = "draggable";
        tr.draggable = true;
        tr.dataset.userId = entry.user_id;

        tr.innerHTML = `
            <td>${entry.position}</td>
            <td>${entry.display_name}</td>
            <td class="copyable" data-bungie="${entry.bungie_name}">
                ${entry.bungie_name}
            </td>
            <td>
                <button class="remove-button" onclick="removeUser('${entry.display_name}')">✖</button>
            </td>
        `;

        tbody.appendChild(tr);
    });

    enableCopyHandlers();
    enableDrag();
}

/* =======================
   ACTIONS
======================= */

async function nextQueue() {
  await fetch("/api/obs/queue/next", { method: "POST" });
  toast("Next group selected");
}

async function toggleQueue() {
  queueOpen = !queueOpen;
  await fetch("/api/obs/queue/toggle", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ open: queueOpen }),
  });
  updateToggle();
  toast(queueOpen ? "Queue opened" : "Queue closed");
}

function updateToggle() {
  const btn = document.getElementById("queueToggle");
  btn.textContent = queueOpen ? "Close Queue" : "Open Queue";
  btn.classList.toggle("closed", !queueOpen);
}

async function removeUser(userId) {
  await fetch("/api/obs/queue/remove", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: userId }),
  });
  toast(queueOpen ? "Queue opened" : "Queue closed");
}


/* =======================
   DRAG & DROP
======================= */

function enableDrag() {
  const rows = document.querySelectorAll(".draggable");

  rows.forEach(row => {
    row.addEventListener("dragstart", () => {
      draggedRow = row;
      row.classList.add("dragging");
    });

    row.addEventListener("dragend", async () => {
      row.classList.remove("dragging");
      draggedRow = null;
      await submitOrder();
    });

    row.addEventListener("dragover", e => {
      e.preventDefault();
      const target = e.target.closest("tr");
      if (target && target !== draggedRow) {
        target.before(draggedRow);
      }
    });
  });
}

async function submitOrder() {
  const order = [...document.querySelectorAll(".draggable")]
    .map(r => r.dataset.userId);

  await fetch("/api/obs/queue/reorder", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ order }),
  });
}

function toast(msg, duration = 1500) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");

    setTimeout(() => {
        t.classList.remove("show");
    }, duration);
}

/* =======================
   SSE
======================= */

const evt = new EventSource("/api/obs/queue/events");
evt.onmessage = loadQueue;

/* =======================
   INIT
======================= */

loadQueue();
</script>
  <div id="toast"></div>
</body>
</html>
